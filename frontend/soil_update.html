<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Soil Update - AgriFusion</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Poppins", sans-serif;
        background: linear-gradient(
            rgba(30, 60, 30, 0.85),
            rgba(20, 40, 20, 0.9)
          ),
          url("https://images.unsplash.com/photo-1599423300746-b62533397364?auto=format&fit=crop&w=1350&q=80")
            no-repeat center center fixed;
        background-size: cover;
        color: #fff;
        min-height: 100vh;
        padding: 20px;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
      }

      .header h1 {
        color: #ffeb3b;
        font-size: 36px;
        margin-bottom: 10px;
      }

      .back-btn {
        background: #f44336;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        text-decoration: none;
        display: inline-block;
        margin-bottom: 20px;
      }

      .back-btn:hover {
        background: #d32f2f;
      }

      .container {
        background: rgba(0, 0, 0, 0.75);
        max-width: 1200px;
        margin: 0 auto;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
      }

      .section {
        margin-bottom: 40px;
      }

      .section h2 {
        color: #ffd54f;
        margin-bottom: 20px;
        font-size: 24px;
        border-bottom: 2px solid #ffeb3b;
        padding-bottom: 10px;
      }

      /* Registration Data Card */
      .registration-card {
        background: rgba(76, 175, 80, 0.2);
        border: 2px solid #4caf50;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
      }

      .registration-card h3 {
        color: #4caf50;
        margin-bottom: 15px;
      }

      /* Form Styles */
      form {
        background: rgba(255, 255, 255, 0.05);
        padding: 25px;
        border-radius: 10px;
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      form label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: #ffd54f;
      }

      form input,
      form textarea {
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #ccc;
        background: white;
        color: #333;
        font-size: 14px;
      }

      form textarea {
        resize: vertical;
        min-height: 80px;
      }

      .submit-btn {
        width: 100%;
        padding: 15px;
        background: linear-gradient(135deg, #4caf50, #45a049);
        border: none;
        border-radius: 8px;
        color: white;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        margin-top: 20px;
        transition: all 0.3s;
      }

      .submit-btn:hover {
        background: linear-gradient(135deg, #45a049, #388e3c);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
      }

      /* Test History Cards */
      .test-history {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
      }

      .test-card {
        background: rgba(255, 255, 255, 0.1);
        padding: 20px;
        border-radius: 10px;
        border: 2px solid rgba(255, 235, 59, 0.3);
        transition: all 0.3s;
        position: relative;
      }

      .test-card:hover {
        transform: translateY(-5px);
        border-color: #ffeb3b;
        box-shadow: 0 8px 20px rgba(255, 235, 59, 0.3);
      }

      .test-card .date {
        color: #ffeb3b;
        font-weight: bold;
        font-size: 16px;
        margin-bottom: 15px;
      }

      .test-data {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }

      .test-data p {
        margin: 5px 0;
        font-size: 14px;
      }

      .test-data strong {
        color: #ffd54f;
      }

      .delete-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background: #f44336;
        color: white;
        border: none;
        padding: 5px 12px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 12px;
      }

      .delete-btn:hover {
        background: #d32f2f;
      }

      .notes {
        grid-column: 1 / -1;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid rgba(255, 255, 255, 0.2);
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #ffeb3b;
        font-size: 18px;
      }

      .no-data {
        text-align: center;
        padding: 40px;
        color: #999;
        font-style: italic;
      }

      @media (max-width: 768px) {
        .form-grid {
          grid-template-columns: 1fr;
        }

        .test-history {
          grid-template-columns: 1fr;
        }

        .test-data {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <a href="farmer.html" class="back-btn">‚Üê Back to Dashboard</a>
        <h1>üå± Soil Testing & Updates</h1>
        <p style="color: #ccc">Track your soil health over time</p>
      </div>

      <!-- Registration Soil Data -->
      <div class="section">
        <h2>üìã Initial Soil Data (From Registration)</h2>
        <div id="registrationData" class="registration-card">
          <div class="loading">Loading initial data...</div>
        </div>
      </div>

      <!-- New Soil Test Form -->
      <div class="section">
        <h2>‚ûï Add New Soil Test</h2>
        <form id="soilForm">
          <div class="form-grid">
            <div class="form-group">
              <label for="N">Nitrogen (N) *</label>
              <input
                type="number"
                id="N"
                step="0.01"
                required
                placeholder="e.g., 40.5"
              />
            </div>

            <div class="form-group">
              <label for="P">Phosphorus (P) *</label>
              <input
                type="number"
                id="P"
                step="0.01"
                required
                placeholder="e.g., 30.2"
              />
            </div>

            <div class="form-group">
              <label for="K">Potassium (K) *</label>
              <input
                type="number"
                id="K"
                step="0.01"
                required
                placeholder="e.g., 25.8"
              />
            </div>

            <div class="form-group">
              <label for="temperature">Temperature (¬∞C) *</label>
              <input
                type="number"
                id="temperature"
                step="0.1"
                required
                placeholder="e.g., 28.5"
              />
            </div>

            <div class="form-group">
              <label for="humidity">Humidity (%) *</label>
              <input
                type="number"
                id="humidity"
                step="0.1"
                min="0"
                max="100"
                required
                placeholder="e.g., 65.0"
              />
            </div>

            <div class="form-group">
              <label for="ph">pH Value *</label>
              <input
                type="number"
                id="ph"
                step="0.1"
                min="0"
                max="14"
                required
                placeholder="e.g., 6.5"
              />
            </div>

            <div class="form-group">
              <label for="moisture">Soil Moisture (%) *</label>
              <input
                type="number"
                id="moisture"
                step="0.1"
                min="0"
                max="100"
                required
                placeholder="e.g., 45.0"
              />
            </div>

            <div class="form-group" style="grid-column: 1 / -1">
              <label for="notes">Notes (Optional)</label>
              <textarea
                id="notes"
                placeholder="Add any observations or notes about this test..."
              ></textarea>
            </div>
          </div>

          <button type="submit" class="submit-btn">üíæ Save Soil Test</button>
        </form>
      </div>

      <!-- Test History -->
      <div class="section">
        <h2>üìä Soil Test History</h2>
        <div id="testHistory" class="test-history">
          <div class="loading">Loading test history...</div>
        </div>
      </div>
    </div>

    <script>
      const username = localStorage.getItem("username");

      if (!username) {
        alert("‚ö†Ô∏è Please login first!");
        window.location.href = "login.html";
      }

      const form = document.getElementById("soilForm");

      // Load soil data
      async function loadSoilData() {
        try {
          const res = await fetch(
            `http://localhost:5000/soil-tests/${username}`
          );

          if (!res.ok) {
            throw new Error("Failed to fetch soil data");
          }

          const data = await res.json();

          // Display registration data
          displayRegistrationData(data.registrationData);

          // Display test history
          displayTestHistory(data.testHistory);
        } catch (error) {
          console.error("Error loading soil data:", error);
          document.getElementById("registrationData").innerHTML =
            '<div style="color: #f44336;">‚ùå Failed to load data. Make sure server is running!</div>';
          document.getElementById("testHistory").innerHTML =
            '<div style="color: #f44336;">‚ùå Failed to load test history.</div>';
        }
      }

      // Display registration soil data
      function displayRegistrationData(soilData) {
        const container = document.getElementById("registrationData");

        if (!soilData || Object.keys(soilData).length === 0) {
          container.innerHTML =
            '<div class="no-data">No initial soil data found</div>';
          return;
        }

        container.innerHTML = `
          <h3>üåæ Soil Data from Your Registration</h3>
          <div class="test-data">
            <p><strong>Nitrogen (N):</strong> ${soilData.N || "N/A"}</p>
            <p><strong>Phosphorus (P):</strong> ${soilData.P || "N/A"}</p>
            <p><strong>Potassium (K):</strong> ${soilData.K || "N/A"}</p>
            <p><strong>Temperature:</strong> ${
              soilData.temperature || "N/A"
            }¬∞C</p>
            <p><strong>Humidity:</strong> ${soilData.humidity || "N/A"}%</p>
            <p><strong>pH:</strong> ${soilData.ph || "N/A"}</p>
            <p><strong>Moisture:</strong> ${soilData.moisture || "N/A"}%</p>
          </div>
        `;
      }

      // Display test history
      function displayTestHistory(tests) {
        const container = document.getElementById("testHistory");

        if (!tests || tests.length === 0) {
          container.innerHTML =
            '<div class="no-data">No soil tests recorded yet. Add your first test above!</div>';
          return;
        }

        container.innerHTML = tests
          .map(
            (test) => `
          <div class="test-card">
            <button class="delete-btn" onclick="deleteTest('${
              test._id
            }')">üóëÔ∏è Delete</button>
            <div class="date">üìÖ ${new Date(test.testDate).toLocaleDateString(
              "en-IN",
              {
                year: "numeric",
                month: "long",
                day: "numeric",
                hour: "2-digit",
                minute: "2-digit",
              }
            )}</div>
            <div class="test-data">
              <p><strong>N:</strong> ${test.N}</p>
              <p><strong>P:</strong> ${test.P}</p>
              <p><strong>K:</strong> ${test.K}</p>
              <p><strong>Temp:</strong> ${test.temperature}¬∞C</p>
              <p><strong>Humidity:</strong> ${test.humidity}%</p>
              <p><strong>pH:</strong> ${test.ph}</p>
              <p><strong>Moisture:</strong> ${test.moisture}%</p>
              ${
                test.notes
                  ? `<div class="notes"><strong>Notes:</strong> ${test.notes}</div>`
                  : ""
              }
            </div>
          </div>
        `
          )
          .join("");
      }

      // Save new soil test
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const soilData = {
          username,
          N: parseFloat(document.getElementById("N").value),
          P: parseFloat(document.getElementById("P").value),
          K: parseFloat(document.getElementById("K").value),
          temperature: parseFloat(document.getElementById("temperature").value),
          humidity: parseFloat(document.getElementById("humidity").value),
          ph: parseFloat(document.getElementById("ph").value),
          moisture: parseFloat(document.getElementById("moisture").value),
          notes: document.getElementById("notes").value,
        };

        try {
          const res = await fetch("http://localhost:5000/soil-test", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(soilData),
          });

          const data = await res.json();

          if (res.ok && data.success) {
            alert("‚úÖ Soil test saved successfully!");
            form.reset();
            loadSoilData(); // Reload to show new test
          } else {
            alert("‚ùå " + (data.message || "Failed to save soil test"));
          }
        } catch (error) {
          console.error("Error saving soil test:", error);
          alert("‚ùå Server error! Please try again.");
        }
      });

      // Delete soil test
      async function deleteTest(testId) {
        if (!confirm("Are you sure you want to delete this soil test?")) {
          return;
        }

        try {
          const res = await fetch(`http://localhost:5000/soil-test/${testId}`, {
            method: "DELETE",
          });

          const data = await res.json();

          if (res.ok && data.success) {
            alert("‚úÖ Soil test deleted successfully!");
            loadSoilData(); // Reload
          } else {
            alert("‚ùå Failed to delete soil test");
          }
        } catch (error) {
          console.error("Error deleting test:", error);
          alert("‚ùå Server error!");
        }
      }

      // Load data on page load
      loadSoilData();
    </script>
  </body>
</html>
